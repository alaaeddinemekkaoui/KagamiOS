#include "vga.h"
#include "idt.h"
#include "boot_info.h"
#include "shell.h"
#include "heap.h"
#include "keyboard.h"
#include "vga_terminal.h"

/* Simple 8x8 font for ASCII characters */
static const uint8_t font_8x8[128][8] = {
    [' '] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['!'] = {0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x00},
    ['"'] = {0x36, 0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['#'] = {0x36, 0x36, 0x7F, 0x36, 0x7F, 0x36, 0x36, 0x00},
    ['$'] = {0x0C, 0x3E, 0x63, 0x30, 0x1E, 0x63, 0x3E, 0x0C},
    ['%'] = {0x63, 0x63, 0x30, 0x18, 0x0C, 0x63, 0x63, 0x00},
    ['&'] = {0x1C, 0x36, 0x36, 0x1E, 0x3B, 0x66, 0x3F, 0x00},
    ['\''] = {0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['('] = {0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00},
    [')'] = {0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00},
    ['*'] = {0x00, 0x18, 0x3C, 0x7E, 0x3C, 0x18, 0x00, 0x00},
    ['+'] = {0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00},
    [','] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30},
    ['-'] = {0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00},
    ['.'] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00},
    ['/'] = {0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x00},
    ['0'] = {0x3E, 0x63, 0x63, 0x6F, 0x63, 0x63, 0x3E, 0x00},
    ['1'] = {0x0C, 0x1C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3F, 0x00},
    ['2'] = {0x3E, 0x63, 0x03, 0x0E, 0x38, 0x60, 0x7F, 0x00},
    ['3'] = {0x3E, 0x63, 0x03, 0x1E, 0x03, 0x63, 0x3E, 0x00},
    ['4'] = {0x0C, 0x1C, 0x3C, 0x6C, 0x7F, 0x0C, 0x0C, 0x00},
    ['5'] = {0x7F, 0x60, 0x7E, 0x03, 0x03, 0x63, 0x3E, 0x00},
    ['6'] = {0x1E, 0x30, 0x60, 0x7E, 0x63, 0x63, 0x3E, 0x00},
    ['7'] = {0x7F, 0x63, 0x06, 0x0C, 0x18, 0x30, 0x30, 0x00},
    ['8'] = {0x3E, 0x63, 0x63, 0x3E, 0x63, 0x63, 0x3E, 0x00},
    ['9'] = {0x3E, 0x63, 0x63, 0x3F, 0x03, 0x06, 0x3C, 0x00},
    [':'] = {0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00},
    [';'] = {0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x30, 0x00},
    ['<'] = {0x06, 0x0C, 0x18, 0x30, 0x18, 0x0C, 0x06, 0x00},
    ['='] = {0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00, 0x00},
    ['>'] = {0x60, 0x30, 0x18, 0x0C, 0x18, 0x30, 0x60, 0x00},
    ['?'] = {0x3E, 0x63, 0x03, 0x0E, 0x18, 0x00, 0x18, 0x00},
    ['@'] = {0x3E, 0x63, 0x6F, 0x6F, 0x6E, 0x60, 0x3E, 0x00},
    ['A'] = {0x1C, 0x36, 0x63, 0x7F, 0x63, 0x63, 0x63, 0x00},
    ['B'] = {0x7E, 0x63, 0x63, 0x7E, 0x63, 0x63, 0x7E, 0x00},
    ['C'] = {0x3E, 0x63, 0x60, 0x60, 0x60, 0x63, 0x3E, 0x00},
    ['D'] = {0x7C, 0x66, 0x63, 0x63, 0x63, 0x66, 0x7C, 0x00},
    ['E'] = {0x7F, 0x60, 0x60, 0x7E, 0x60, 0x60, 0x7F, 0x00},
    ['F'] = {0x7F, 0x60, 0x60, 0x7E, 0x60, 0x60, 0x60, 0x00},
    ['G'] = {0x3E, 0x63, 0x60, 0x6F, 0x63, 0x63, 0x3E, 0x00},
    ['H'] = {0x63, 0x63, 0x63, 0x7F, 0x63, 0x63, 0x63, 0x00},
    ['I'] = {0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00},
    ['J'] = {0x1F, 0x0C, 0x0C, 0x0C, 0x6C, 0x6C, 0x38, 0x00},
    ['K'] = {0x63, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0x63, 0x00},
    ['L'] = {0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7F, 0x00},
    ['M'] = {0x63, 0x77, 0x7F, 0x6B, 0x63, 0x63, 0x63, 0x00},
    ['N'] = {0x63, 0x73, 0x7B, 0x6F, 0x67, 0x63, 0x63, 0x00},
    ['O'] = {0x3E, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3E, 0x00},
    ['P'] = {0x7E, 0x63, 0x63, 0x7E, 0x60, 0x60, 0x60, 0x00},
    ['Q'] = {0x3E, 0x63, 0x63, 0x63, 0x63, 0x3E, 0x0F, 0x00},
    ['R'] = {0x7E, 0x63, 0x63, 0x7E, 0x6C, 0x66, 0x63, 0x00},
    ['S'] = {0x3E, 0x63, 0x60, 0x3E, 0x03, 0x63, 0x3E, 0x00},
    ['T'] = {0x7F, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},
    ['U'] = {0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3E, 0x00},
    ['V'] = {0x63, 0x63, 0x36, 0x36, 0x1C, 0x1C, 0x08, 0x00},
    ['W'] = {0x63, 0x63, 0x63, 0x6B, 0x7F, 0x77, 0x63, 0x00},
    ['X'] = {0x63, 0x36, 0x1C, 0x08, 0x1C, 0x36, 0x63, 0x00},
    ['Y'] = {0x63, 0x36, 0x1C, 0x08, 0x08, 0x08, 0x08, 0x00},
    ['Z'] = {0x7F, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x7F, 0x00},
    ['['] = {0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00},
    ['\\'] = {0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x00},
    [']'] = {0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00},
    ['^'] = {0x08, 0x1C, 0x36, 0x63, 0x00, 0x00, 0x00, 0x00},
    ['_'] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00},
    ['`'] = {0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['a'] = {0x00, 0x00, 0x3E, 0x03, 0x3F, 0x63, 0x3F, 0x00},
    ['b'] = {0x60, 0x60, 0x7E, 0x63, 0x63, 0x63, 0x7E, 0x00},
    ['c'] = {0x00, 0x00, 0x3E, 0x63, 0x60, 0x63, 0x3E, 0x00},
    ['d'] = {0x03, 0x03, 0x3F, 0x63, 0x63, 0x63, 0x3F, 0x00},
    ['e'] = {0x00, 0x00, 0x3E, 0x63, 0x7F, 0x60, 0x3E, 0x00},
    ['f'] = {0x1E, 0x30, 0x30, 0x7E, 0x30, 0x30, 0x30, 0x00},
    ['g'] = {0x00, 0x00, 0x3F, 0x63, 0x63, 0x3F, 0x03, 0x3E},
    ['h'] = {0x60, 0x60, 0x7E, 0x63, 0x63, 0x63, 0x63, 0x00},
    ['i'] = {0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00},
    ['j'] = {0x18, 0x00, 0x1C, 0x0C, 0x0C, 0x0C, 0x6C, 0x38},
    ['k'] = {0x60, 0x60, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0x00},
    ['l'] = {0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00},
    ['m'] = {0x00, 0x00, 0x7F, 0x6B, 0x6B, 0x6B, 0x6B, 0x00},
    ['n'] = {0x00, 0x00, 0x7E, 0x63, 0x63, 0x63, 0x63, 0x00},
    ['o'] = {0x00, 0x00, 0x3E, 0x63, 0x63, 0x63, 0x3E, 0x00},
    ['p'] = {0x00, 0x00, 0x7E, 0x63, 0x63, 0x7E, 0x60, 0x60},
    ['q'] = {0x00, 0x00, 0x3F, 0x63, 0x63, 0x3F, 0x03, 0x03},
    ['r'] = {0x00, 0x00, 0x6E, 0x73, 0x60, 0x60, 0x60, 0x00},
    ['s'] = {0x00, 0x00, 0x3E, 0x60, 0x3E, 0x03, 0x7E, 0x00},
    ['t'] = {0x30, 0x30, 0x7E, 0x30, 0x30, 0x33, 0x1E, 0x00},
    ['u'] = {0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x3F, 0x00},
    ['v'] = {0x00, 0x00, 0x63, 0x36, 0x36, 0x1C, 0x08, 0x00},
    ['w'] = {0x00, 0x00, 0x63, 0x6B, 0x6B, 0x7F, 0x36, 0x00},
    ['x'] = {0x00, 0x00, 0x36, 0x1C, 0x08, 0x1C, 0x36, 0x00},
    ['y'] = {0x00, 0x00, 0x63, 0x36, 0x1C, 0x08, 0x08, 0x30},
    ['z'] = {0x00, 0x00, 0x7F, 0x06, 0x18, 0x60, 0x7F, 0x00},
    ['{'] = {0x0E, 0x18, 0x18, 0x30, 0x18, 0x18, 0x0E, 0x00},
    ['|'] = {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},
    ['}'] = {0x70, 0x18, 0x18, 0x0C, 0x18, 0x18, 0x70, 0x00},
    ['~'] = {0x3B, 0x6E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
};

static const char* k_logo[] = {
    "------------------------------------------------", 
    " _  __   _     ____    _     __  __  ___",
    "| |/ /  / \\  / ___|  / \\  |  \\/  |_ _|",
    "| ' /  / _ \\| |  _  / _ \\ | |\\/| || |",
    "| . \\ / ___ \\ |_| |/ ___ \\| |  | || |",
    "|_|\\_\\_/   \\_\\____/_/   \\_\\_|  |_|___|",
    "",
    "            K A G A M I   O S",
    "            \"Awakening\""
};

static inline void outb(uint16_t port, uint8_t val) {
    __asm__ __volatile__("outb %0, %1" : : "a"(val), "Nd"(port));
}

static inline uint8_t inb(uint16_t port) {
    uint8_t ret;
    __asm__ __volatile__("inb %1, %0" : "=a"(ret) : "Nd"(port));
    return ret;
}

static void serial_init(void) {
    outb(0x3F8 + 1, 0x00);    /* Disable all interrupts */
    outb(0x3F8 + 3, 0x80);    /* Enable DLAB (set baud rate divisor) */
    outb(0x3F8 + 0, 0x03);    /* Set divisor to 3 (lo byte) 38400 baud */
    outb(0x3F8 + 1, 0x00);    /*                  (hi byte) */
    outb(0x3F8 + 3, 0x03);    /* 8 bits, no parity, one stop bit */
    outb(0x3F8 + 2, 0xC7);    /* Enable FIFO, clear them, 14-byte threshold */
    outb(0x3F8 + 4, 0x0B);    /* IRQs enabled, RTS/DSR set */
}

static int serial_is_transmit_empty(void) {
    return inb(0x3F8 + 5) & 0x20;
}

static void serial_write_char(char c) {
    while (!serial_is_transmit_empty()) { }
    outb(0x3F8, (uint8_t)c);
}

static void serial_write(const char* s) {
    while (*s) {
        if (*s == '\n') {
            serial_write_char('\r');
        }
        serial_write_char(*s++);
    }
}
/* Framebuffer functions */
static void fb_putpixel(uint32_t* fb, uint32_t pitch, uint32_t x, uint32_t y, uint32_t color) {
    fb[y * (pitch / 4) + x] = color;
}

static void fb_putchar(uint32_t* fb, uint32_t pitch, uint32_t x, uint32_t y, char c, uint32_t color) {
    if (c < 0 || c >= 128) return;
    
    const uint8_t* glyph = font_8x8[(int)c];
    for (int row = 0; row < 8; row++) {
        uint8_t bits = glyph[row];
        for (int col = 0; col < 8; col++) {
            if (bits & (1 << (7 - col))) {
                fb_putpixel(fb, pitch, x + col, y + row, color);
            }
        }
    }
}

static void fb_print(uint32_t* fb, uint32_t pitch, uint32_t x, uint32_t y, const char* str, uint32_t color) {
    uint32_t cur_x = x;
    uint32_t cur_y = y;
    
    while (*str) {
        if (*str == '\n') {
            cur_x = x;
            cur_y += 8;
        } else {
            fb_putchar(fb, pitch, cur_x, cur_y, *str, color);
            cur_x += 8;
        }
        str++;
    }
}

/* Scaled version for larger characters */
static void fb_putchar_scaled(uint32_t* fb, uint32_t pitch, uint32_t x, uint32_t y, char c, uint32_t color, int scale) {
    if (c < 0 || c >= 128) return;
    
    const uint8_t* glyph = font_8x8[(int)c];
    for (int row = 0; row < 8; row++) {
        uint8_t bits = glyph[row];
        for (int col = 0; col < 8; col++) {
            if (bits & (1 << (7 - col))) {
                /* Draw scaled pixel block */
                for (int sy = 0; sy < scale; sy++) {
                    for (int sx = 0; sx < scale; sx++) {
                        fb_putpixel(fb, pitch, x + col * scale + sx, y + row * scale + sy, color);
                    }
                }
            }
        }
    }
}

static void fb_print_scaled(uint32_t* fb, uint32_t pitch, uint32_t x, uint32_t y, const char* str, uint32_t color, int scale) {
    uint32_t cur_x = x;
    uint32_t cur_y = y;
    uint32_t char_width = 8 * scale;
    uint32_t char_height = 8 * scale;
    
    while (*str) {
        if (*str == '\n') {
            cur_x = x;
            cur_y += char_height;
        } else {
            fb_putchar_scaled(fb, pitch, cur_x, cur_y, *str, color, scale);
            cur_x += char_width;
        }
        str++;
    }
}

void kernel_main(void) {
    serial_init();
   // serial_write("KERNEL OK! (serial)\n");

    /* Get boot info */
    BOOT_INFO* boot_info = get_boot_info();
    
    if (!boot_info_valid()) {
        serial_write("ERROR: Invalid boot info!\n");
        while (1) { __asm__ __volatile__("hlt"); }
    }
    
    serial_write("Boot info valid\n");
    
    /* Kagami OS ASCII art logo */
    const char* kagami_logo[] = {
        "  _  __   _    ____    _    __  __ ___",
        " | |/ /  / \\  / ___|  / \\  |  \\/  |_ _|",
        " | ' /  / _ \\| |  _  / _ \\ | |\\/| || |",
        " | . \\ / ___ \\ |_| |/ ___ \\| |  | || |",
        " |_|\\_\\_/   \\_\\____/_/   \\_\\_|  |_|___|",
        "",
        " K A G A M I   O S",
        " \"Awakening\"  0.1",
    };
    
    /* Check if we have a framebuffer */
    if (boot_info->framebuffer_addr != 0) {
        uint32_t* fb = (uint32_t*)(uint64_t)boot_info->framebuffer_addr;
        uint32_t pitch = boot_info->framebuffer_pitch;
        uint32_t width = boot_info->framebuffer_width;
        uint32_t height = boot_info->framebuffer_height;
        
        serial_write("Using GOP framebuffer\n");
        
        /* Clear screen to black */
        for (uint32_t y = 0; y < height; y++) {
            for (uint32_t x = 0; x < width; x++) {
                fb_putpixel(fb, pitch, x, y, 0x000000);
            }
        }
        
        serial_write("Screen cleared\n");
        
        /* Calculate dimensions for scaled logo (2x scale) */
        int scale = 2;
        int logo_width = 40 * 8 * scale;  /* ~40 chars wide, 8 pixels per char, 2x scale */
        int logo_height = 8 * 8 * scale;  /* 8 lines, 8 pixels per char, 2x scale */
        
        /* Center logo on screen */
        int center_x = ((int)width > logo_width) ? ((int)width - logo_width) / 2 : 20;
        int center_y = ((int)height > logo_height) ? ((int)height - logo_height) / 2 : 50;
        uint32_t logo_x = (uint32_t)center_x;
        uint32_t logo_y = (uint32_t)center_y;
        
        /* Draw Kagami OS ASCII art logo in cyan, scaled 2x */
        for (int i = 0; i < 8; i++) {
            fb_print_scaled(fb, pitch, logo_x, logo_y + (i * 16 * scale), kagami_logo[i], 0x00FFFF, scale);
        }
        
        serial_write("ASCII art logo drawn\n");
    } else {
        serial_write("No framebuffer available, trying VGA\n");
        
        /* Fallback to VGA text mode */
        volatile uint16_t* vga = (uint16_t*)0xB8000;
        vga[0] = 'K' | (0x0A << 8);
        vga[1] = 'E' | (0x0A << 8);
        vga[2] = 'R' | (0x0A << 8);
        vga[3] = 'N' | (0x0A << 8);
        vga[4] = 'E' | (0x0A << 8);
        vga[5] = 'L' | (0x0A << 8);
        vga[6] = ' ' | (0x0A << 8);
        vga[7] = 'O' | (0x0A << 8);
        vga[8] = 'K' | (0x0A << 8);
        vga[9] = '!' | (0x0A << 8);
    }
    
    serial_write("Kernel halting\n");
    
    /* Halt forever */
    while (1) {
        __asm__ __volatile__("hlt");
    }
}
